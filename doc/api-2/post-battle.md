`POST /api/v2/battle`
===================

| | |
|-|-|
|Verb|`POST`|
|URL|`https://stat.ink/api/v2/battle`|
|Return-Type|成功した場合 `201 Created` (bodyなし)<br>失敗した場合 `application/json` または `text/html`|
|認証|[必要](authorization.md)|

バトルデータをstat.inkに投稿します。

投稿時のリクエストボディの形式については[request-body.md](request-body.md)を参照してください。


パラメータ
----------

基本的に全てのパラメータは省略可能です。ただし、あまりに内容がない場合はエラーになります。

POST データは全体で 12MiB 以内である必要があります。

|キー|値の型||
|-|-|-|
|`uuid`|文字列(64文字以下)<br>推奨:[UUID](https://tools.ietf.org/html/rfc4122)|バトル重複のチェックに使用します。<br>同一UUIDのPOSTが一定期間内に行われた場合、サーバは保存せずに以前の情報を返します。<br>クライアントはバトルごとに任意のUUIDまたは文字列を生成して付与することができます。<br>クライアントが生成した文字列がUUIDに見えない時はサーバ側でそれを元に適当なUUIDに変換します。|
|`lobby`|指定文字列|どのロビーからバトルを行ったかを指定します。<br>`standard` : 野良バトル|
|`mode`|指定文字列|どのプレーモードでバトルを行ったかを指定します。<br>`regular` : レギュラーマッチ|
|`rule`|指定文字列|どのルールでバトルを行ったかを指定します。<br>`nawabari` : ナワバリバトル|
|`stage`|指定文字列|どのステージ（マップ）でバトルを行ったかを指定します。（後述）|
|`weapon`|指定文字列|このバトルを投稿するプレーヤーがどのブキを使用したかを指定します。（後述）|
|`result`|指定文字列|バトルの勝敗に応じた値を設定します。<br>`win` : 勝利<br>`lose` : 敗北|
|`rank_in_team`|整数(1～4)|プレーヤーがリザルト画面のチーム内何番目に表示されたかを指定します。|
|`kill`|整数(0～99)|プレーヤーのキルの数を指定します。|
|`death`|整数(0～99)|プレーヤーのデスの数を指定します。|
|`level`|整数(1～50?)|プレーヤーのバトル開始時のランクを指定します。（Splatoon 2の仕様次第で変更の可能性あり）|
|`level_after`|整数(1～50?)|同様にバトル終了後のランクを指定します。|
|`my_point`|整数(0～)|自分が塗ったポイントと勝利ボーナスを合計した数値を指定します。（画面に表示されるままのポイント）|
|`my_team_point`|整数(0～)|リザルト画面の自分のチームの最終塗りポイントを指定します。|
|`his_team_point`|整数(0～)|同様に敵チームのポイントを指定します。|
|`my_team_percent`|数値(0.0～100.0)|同様に自分のチームの塗りポイントのパーセンテージを指定します。|
|`his_team_percent`|数値(0.0～100.0)|同様に敵チームのパーセンテージを指定します。|
|`players`|構造体|自分を含めた両チーム8人分のデータを指定します。（後述）|
|`death_reasons`|マップ|自分が死んだ死因を指定します。（後述）|
|`events`|配列|ゲーム中の進行状況に対応する時系列データを指定します。（後述）|
|`automated`|指定文字列|自動化された投稿か手動による投稿かを指定します。<br>この情報は、全体統計に使用できるかを判定するのに使用します。<br>（意図的に勝利データのみを送信するのが容易かを示すものと考えてください）<br>`yes` : 自動化されている（機械的に処理されている）<br>`no` : 自動化されていない（手動入力等）|
|`link_url`|文字列(URL)|このバトルに関連したURLを指定します。<br>一般的には、バトルの録画をアップロードしたYouTubeへのURLを指定します。|
|`note`|文字列|このバトルに関連するメモを指定します。|
|`private_note`|文字列|同様ですが、本人以外には表示不可能な秘密のメモを指定します。|
|`agent`|文字列(64文字以下)|投稿に利用するクライアントの名称を指定します。<br>例えば `IkaLog` などのソフトウェアの名称を指定します。<br>他のクライアントと重複しないような名前をつけてください。<br>これを指定するとき、`agent_version`も指定必須となります。|
|`agent_version`|文字列(255文字以下)|`agent`で示されるクライアントのバージョン情報を指定します。<br>アーキテクチャやOSに関する情報を含めることもできます。|
|`agent_custom`|文字列|クライアントがクライアント自身のために利用するデータを指定できます。stat.inkは内容には関知しません。|
|`agent_variables`|マップ|クライアント定義のキー・バリューを指定出来ます。（後述）|
|`image_judge`|画像バイナリ(PNG/JPEG)|ジャッジ画面のスクリーンショットを指定します。|
|`image_result`|画像バイナリ(PNG/JPEG)|リザルト画面（8人分のデータが並んだ画面）のスクリーンショットを指定します。|
|`image_gear`|画像バイナリ(PNG/JPEG)|ギア構成画面のスクリーンショットを指定します。|
|`start_at`|整数(UNIX時間)|バトル開始日時をunix時間（単位は秒）で指定します。|
|`end_at`|整数(UNIX時間)|バトル終了日時をunix時間（単位は秒）で指定します。|


`stage`
-------

[GET /api/v2/stage](get-stage.md)で詳細情報が取得可能です。

|指定文字列|ステージ|
|-|-|
|battera|バッテラストリート|
|combu|コンブトラック|
|fujitsubo|フジツボスポーツクラブ|
|gangaze|ガンガゼ野外音楽堂|


`weapon`
--------

[GET /api/v2/weapon](get-weapon.md)で詳細情報が取得可能です。

|指定文字列|ブキ|
|-|-|
|sshooter|スプラシューター|
|manueuver|スプラマニューバー|
|splatroller|スプラローラー|
|splatcharger|スプラチャージャー|


`players`
---------

`players`には、敵味方2～8人の情報を配列で設定します。配列の中身は後述の構造体で、全体としてこのようになっています。(JSON)

```js
{
  // ...
  "players": [
    {
      // 次に指定する構造体
    },
    // 2～8要素
  ],
  // ...
}
```

|キー|値の型||
|-|-|-|
|`team`|指定文字列|`my` : 自分のチーム<br>`his` : 相手のチーム|
|`is_me`|指定文字列|`yes` : 投稿者<br>`no` : 投稿者以外|
|`weapon`|指定文字列|そのプレーヤーの持っていた武器(指定する値は前述の通り)|
|`level`|整数(1～50?)|そのプレーヤーのランクを指定します|
|`rank_in_team`|整数(1～4)|そのプレーヤーが各チーム内で何番目に表示されているかを指定します|
|`kill`|整数(0～99)|そのプレーヤーのキル数を指定します|
|`death`|整数(0～99)|そのプレーヤーのデス数を指定します|
|`point`|整数(0～)|そのプレーヤーのポイント(塗った面積+ボーナス)を指定します|
|`my_kill`|整数(0～)|そのプレーヤーのデス数のうち、投稿プレーヤーが倒した数を指定します|


`death_reasons`
---------------

プレーヤーの死因とその回数を集計の上、設定します。

死因をキー、回数を値とするマップを設定します。

場外転落で1回、スプラマニューバーで2回死んだとき、つぎのような電文になります。

```js
{
  // ...
  "death_reasons": {
    "oob": 1,
    "manueuver": 2
  },
  // ...
}
```

キーとなる死因は、`weapon`のための指定文字列と、次の各値になります。

|指定文字列|死因|
|-|-|
|`unknown`|死因不明|
|`fall`|場外転落|
|`drown`|水死|
|`oob`|場外（詳細不明）|

|指定文字列|死因|
|-|-|
|`curlingbomb`|カーリングボム|
|`kyubanbomb`|キューバンボム|
|`quickbomb`|クイックボム|
|`splashbomb`|スプラッシュボム|

|指定文字列|死因|
|-|-|
|`chakuchi`|スーパーチャクチ|
|`jetpack`|ジェットパック|
|`missile`|マルチミサイル|
|`presser`|ハイパープレッサー|


`events`
--------

バトル中に発生した各種時系列イベントデータを配列で指定します。

```js
{
  // ...
  "events": [
    {
      "at": 0.1,
      "type": "point",
      "point": 2
    },
    // ...
  ],
  // ...
}
```

|キー|値の型|必須?||
|-|-|-|-|
|`at`|数値|必須|イベント発生タイミング（バトル開始からの秒）|
|`type`|文字列|必須|イベント種別|
|type依存のキー|||type依存の値


### `type: point`

塗りポイントの変化に関するイベントです。

|キー|値の型|必須?||
|-|-|-|
|`point`|数値(0～)|必須|塗りポイントを指定します|


### `type: killed`

プレーヤーが他のプレーヤーをキルしたことを示すイベントです。

追加の情報はありません。


### `type: dead`

プレーヤーが他のプレーヤーにキルされたことを示すイベントです。

|キー|値の型|必須?||
|-|-|-|
|`reason`|指定文字列||死因を指定します。`death_reasons`の指定値が利用できます。|


### `type: special%`

プレーヤーのスペシャルゲージのたまり状況を示すイベントです。

|キー|値の型|必須?||
|-|-|-|
|`point`|数値(0～)|必須|スペシャルゲージのたまりを指定します|


### `type: alive_inklings`

各プレーヤーの生死状況を示すイベントです。変化したタイミングでの発行を期待しています。

|キー|値の型|必須?||
|-|-|-|
|`my_team`|配列|必須|味方チームの生死を示します。|
|`his_team`|配列|必須|敵チームの生死を示します。|

`my_team`, `his_team` ともに、最大4要素の配列で、生きているイカを`true`、死んでいるイカを`false`で示します。

```js
{
  "at": 42.0,
  "type": "alive_inklings",
  "my_team": [ true, true, true, false ],
  "his_team": [ true, true, false, true ]
}
```

### 書きかけ


`agent_variables`
-----------------

送信クライアント定義のシンプルなkey-valueペアを指定することができます。
key, value ともに valid な UTF-8 の文字列である必要があります。
この項目は「追加情報」としてバトル詳細に表示されます。
長さはこのパラメータ以外も含めて POST データ全体が 12MiB 以内に収まる必要があります。

`key` は `snake_case` の英数字のみを推奨します。

`key` が数字のみを含むデータの取り扱いは未定義です。

`value` に文字列以外のデータを渡したときの取り扱いは未定義です。


----

[![CC-BY 4.0](https://stat.ink/static-assets/cc/cc-by.svg)](http://creativecommons.org/licenses/by/4.0/deed.ja)

この文章は[Creative Commons - 表示 4.0 国際](http://creativecommons.org/licenses/by/4.0/deed.ja)の下にライセンスされています。

